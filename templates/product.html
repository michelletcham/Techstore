<!-- product.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Produit - Techstore By Michelle</title>
    <link rel="stylesheet" href="/static/bootstrap_custom.css">
    <link rel="stylesheet" href="/static/modern.css">
</head>
<body>
    <nav style="margin-bottom: 24px;">
        <a href="/">Accueil</a> |
        <a href="/products">Produits</a>
        {% if user %}
            <a href="/profile" style="font-weight:bold; background:#eee; padding:6px 18px; border-radius:20px; margin-left:10px;">Profil</a>
            | <a href="/logout">D√©connexion</a>
            {% if user.is_admin %}| <a href="/admin">Admin</a>{% endif %}
        {% else %}
            | <a href="/login">Connexion</a>
            | <a href="/signup">Inscription</a>
        {% endif %}
    </nav>
    <h1>Nos produits Tech</h1>
    <div class="mb-4" style="max-width:400px;margin-bottom:24px;">
        <input type="text" id="search-bar" class="form-control" placeholder="Rechercher un produit..." oninput="filterProducts()">
    </div>
    {% if request.query_params.get('added') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert" id="added-popup" style="max-width:400px;">
            <strong>Produit ajout√© au panier !</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
        </div>
        <script>
        setTimeout(function() {
            var el = document.getElementById('added-popup');
            if (el) el.style.display = 'none';
        }, 5000);
        </script>
    {% endif %}
        <!-- Loader Bootstrap -->
        <div id="global-loader" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:3000;align-items:center;justify-content:center;">
            <div class="spinner-border text-primary" role="status" style="width:4rem;height:4rem;">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
        <script>
        // Affiche le loader lors de la soumission d'un formulaire d'ajout au panier
        document.querySelectorAll('form[action="/cart/add"]').forEach(function(form) {
            form.addEventListener('submit', function() {
                document.getElementById('global-loader').style.display = 'flex';
            });
        });
        // Masque le loader apr√®s 2s si jamais il reste affich√© (s√©curit√©)
        setTimeout(function(){
            var loader = document.getElementById('global-loader');
            if(loader) loader.style.display = 'none';
        }, 2000);
        </script>
    <a href="javascript:history.back()" style="display:inline-block;margin-bottom:18px;color:#2563eb;text-decoration:underline;font-weight:bold;">&larr; Retour</a>
    <div class="product-list" id="product-list">
        {% for product in products %}
        <a href="/product/{{ product.id }}" class="product-link" style="text-decoration:none;color:inherit;display:block;">
            <div class="card product-item" style="cursor:pointer;">
                {% if product.image_url %}
                <img src="{{ product.image_url }}" alt="{{ product.name }}">
                {% endif %}
                <h2 class="product-name">{{ product.name }}</h2>
                <p class="product-desc">{{ product.description }}</p>
                <p><strong class="product-price">{{ product.price }} ‚Ç¨</strong></p>
                {% if product.stock > 0 %}
                <form method="post" action="/cart/add" onClick="event.stopPropagation();">
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}">
                    <button type="submit">Ajouter au panier</button>
                </form>
                <span style="color:#2563eb;font-weight:bold;">Stock : {{ product.stock }}</span>
                {% else %}
                <span style="color:red;font-weight:bold;">√âpuis√©</span>
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
    <script>
    function filterProducts() {
        var input = document.getElementById('search-bar').value.toLowerCase();
        var products = document.querySelectorAll('#product-list .product-link');
        products.forEach(function(prod) {
            var name = prod.querySelector('.product-name').textContent.toLowerCase();
            var desc = prod.querySelector('.product-desc').textContent.toLowerCase();
            if (name.includes(input) || desc.includes(input)) {
                prod.style.display = '';
            } else {
                prod.style.display = 'none';
            }
        });
    }
    </script>
    {% if user %}
    <a href="/cart" style="position:fixed;bottom:32px;right:32px;z-index:1000;box-shadow:0 2px 8px #bbb;font-weight:bold;background:#1e90ff;color:#fff;padding:16px 32px;border-radius:32px;text-decoration:none;">üõí Panier</a>
    <div id="chat-bubble" onclick="toggleChat()" style="position:fixed;bottom:32px;right:100px;z-index:2000;width:64px;height:64px;background:#4a4e69;border-radius:50%;box-shadow:0 2px 8px #bbb;display:flex;align-items:center;justify-content:center;cursor:pointer;">
        <span style="font-size:2.2em;color:#fff;">üí¨</span>
    </div>
    <div id="chat-box" style="display:none;position:fixed;bottom:32px;right:100px;z-index:2001;width:320px;max-width:90vw;background:#fff;border-radius:18px;box-shadow:0 4px 24px #0003;overflow:hidden;">
        <div style="background:#4a4e69;color:#fff;padding:12px 18px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;">
            <span>Service client</span>
            <span style="cursor:pointer;font-size:1.2em;" onclick="toggleChat()">‚úñ</span>
        </div>
        <div id="chat-body" style="height:180px;overflow-y:auto;padding:12px 12px 0 12px;background:#f7f8fa;"></div>
        <div style="display:flex;align-items:center;padding:8px 12px 12px 12px;background:#f7f8fa;">
            <input id="chat-input" type="text" placeholder="Votre message..." style="flex:1;padding:8px 12px;border-radius:8px;border:1px solid #c9ada7;margin-right:8px;">
            <button onclick="sendMessage()" style="background:#4a4e69;color:#fff;border:none;border-radius:8px;padding:8px 16px;">Envoyer</button>
        </div>
    </div>
    <script src="/static/chat.js"></script>
    <style>
    .chat-message.user { background:#e0e0ff; color:#222; margin:6px 0; padding:7px 12px; border-radius:12px 12px 2px 12px; text-align:right; }
    .chat-message.support { background:#f2e9e4; color:#4a4e69; margin:6px 0; padding:7px 12px; border-radius:12px 12px 12px 2px; text-align:left; }
    #chat-body { font-size:1em; }
    </style>
    {% endif %}
</body>
</html>